<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ÙØ§Ú©ØªÙˆØ± Ø¹Ù…Ø¯Ù‡â€ŒÙØ±ÙˆØ´ÛŒ | Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±</title>
    <!-- html2canvas Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ PNG Ùˆ jsPDF Ø¨Ø±Ø§ÛŒ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #f3f4f6;
            min-height: 100vh;
            padding: 12px;
            display: flex;
            justify-content: center;
        }
        .app-container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px 16px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 1.6rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            border-right: 6px solid #3b82f6;
            padding-right: 12px;
        }
        .header-fields {
            background: #f8fafc;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            border: 1px solid #e2e8f0;
        }
        .field-group {
            flex: 1 1 calc(50% - 6px);
            min-width: 140px;
        }
        .field-group label {
            display: block;
            font-size: 0.75rem;
            color: #475569;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .field-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 14px;
            font-size: 0.95rem;
            background: white;
            transition: 0.2s;
        }
        .field-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
        }
        .rate-row {
            background: #dbeafe;
            border-radius: 16px;
            padding: 10px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            color: #1e40af;
        }
        .rate-row label {
            font-size: 1rem;
        }
        .rate-row input {
            width: 100px;
            padding: 8px 12px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            text-align: center;
            background: white;
            border: 1px solid #bfdbfe;
        }
        .products-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0 25px;
        }
        .product-card {
            background: #ffffff;
            border: 1px solid #e9eef2;
            border-radius: 24px;
            padding: 16px 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
            position: relative;
        }
        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .row-num {
            background: #3b82f6;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }
        .delete-btn {
            background: #fee2e2;
            border: none;
            color: #b91c1c;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-btn:hover {
            background: #fecaca;
        }
        .product-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 8px;
        }
        .product-fields > div {
            flex: 1 1 calc(50% - 4px);
            min-width: 130px;
        }
        .product-fields label {
            font-size: 0.7rem;
            color: #64748b;
            display: block;
            margin-bottom: 2px;
            font-weight: 500;
        }
        .product-fields input, .product-fields span.readonly-field {
            width: 100%;
            padding: 10px 8px;
            border: 1px solid #d1d5db;
            border-radius: 14px;
            font-size: 0.9rem;
            background: white;
        }
        .product-fields input:focus {
            border-color: #3b82f6;
            outline: none;
        }
        .product-fields span.readonly-field {
            background: #f1f5f9;
            color: #0f172a;
            display: inline-block;
            border: 1px dashed #94a3b8;
            font-weight: 500;
        }
        .full-row {
            flex: 1 1 100% !important;
        }
        .profit-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: #f1f5f9;
            border-radius: 18px;
            padding: 12px 8px;
            margin-top: 8px;
        }
        .profit-item {
            flex: 1 0 calc(50% - 4px);
            min-width: 110px;
            font-size: 0.8rem;
        }
        .profit-item span {
            font-weight: 700;
            color: #075985;
        }
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .btn {
            flex: 1 1 auto;
            background: #3b82f6;
            border: none;
            color: white;
            padding: 14px 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 5px 10px rgba(59,130,246,0.3);
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 130px;
        }
        .btn-secondary {
            background: #334155;
            box-shadow: none;
        }
        .btn-success {
            background: #10b981;
        }
        .btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }
        .export-area {
            margin-top: 25px;
            text-align: center;
            font-size: 0.8rem;
            color: #6b7280;
        }
        /* Ø¨Ø®Ø´ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ‡ÛŒÙ‡ Ø®Ø±ÙˆØ¬ÛŒ */
        #export-table-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            background: white;
            padding: 20px;
            width: 800px;
            direction: rtl;
        }
        .export-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .export-table th, .export-table td {
            border: 1px solid #aaa;
            padding: 6px 4px;
            text-align: center;
        }
        .export-table th {
            background: #2563eb;
            color: white;
        }
        .footer-note {
            margin-top: 15px;
            color: #475569;
            font-size: 0.75rem;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="app-container" id="app">
    <h1>ğŸ§¾ ÙØ§Ú©ØªÙˆØ± Ø®Ø±ÛŒØ¯ Ø¹Ù…Ø¯Ù‡</h1>

    <!-- Ù†Ø±Ø® Ø§Ø±Ø² (ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ø§ÙØºØ§Ù†ÛŒ) -->
    <div class="rate-row">
        <label>ğŸ’° Ù‡Ø± Ø§ÙØºØ§Ù†ÛŒ (AF) = <span style="font-weight:700;">ØªÙˆÙ…Ø§Ù†</span></label>
        <input type="number" id="exchangeRate" value="2200" step="1" min="1">
    </div>

    <!-- Ù‡Ø¯Ø± ÙØ§Ú©ØªÙˆØ± (Ø´Ù…Ø§Ø±Ù‡ØŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ØŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ØŒ Ø®Ø±ÛŒØ¯Ø§Ø±) -->
    <div class="header-fields">
        <div class="field-group">
            <label>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</label>
            <input type="text" id="invoiceNo" placeholder="Ù…Ø«Ø§Ù„: Û±Û´Û°Û³-Û°Û±" value="Û±Û´Û°Û³-Û°Û°Û±">
        </div>
        <div class="field-group">
            <label>ØªØ§Ø±ÛŒØ® Ø®Ø±ÛŒØ¯</label>
            <input type="date" id="purchaseDate" value="2025-03-10">
        </div>
        <div class="field-group">
            <label>ØªØ§Ø±ÛŒØ® ÙØ±ÙˆØ´ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <input type="date" id="saleDate">
        </div>
        <div class="field-group">
            <label>ÙØ±ÙˆØ´Ù†Ø¯Ù‡</label>
            <input type="text" id="seller" placeholder="Ù†Ø§Ù… Ø¹Ù…Ø¯Ù‡â€ŒÙØ±ÙˆØ´" value="Ø±Ø¶Ø§ÛŒÛŒ">
        </div>
        <div class="field-group">
            <label>Ø®Ø±ÛŒØ¯Ø§Ø±</label>
            <input type="text" id="buyer" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ" value="Ø§Ø­Ù…Ø¯ÛŒ">
        </div>
    </div>

    <!-- Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª Ú©Ø§Ø±Øª -->
    <div id="productsContainer" class="products-area"></div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª -->
    <div style="display: flex; gap:10px; justify-content: center;">
        <button class="btn" id="addProductBtn">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</button>
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ -->
    <div class="action-buttons">
        <button class="btn btn-success" id="exportPngBtn">ğŸ“¸ Ø®Ø±ÙˆØ¬ÛŒ PNG</button>
        <button class="btn btn-secondary" id="exportPdfBtn">ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
        <button class="btn btn-secondary" id="shareBtn" style="background:#8b5cf6;">ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©</button>
    </div>

    <div class="footer-note">
        âš¡ Ù‚ÛŒÙ…Øª ØªÚ©ÛŒ/Ø¨Ø³ØªÙ‡ Ùˆ Ø³ÙˆØ¯Ù‡Ø§ Ø¨Ù‡â€ŒØ·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø³ØªÙ‚ÛŒÙ… Ù‡Ø± ÙÛŒÙ„Ø¯ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯.
    </div>
</div>

<!-- Ø¨Ø®Ø´ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ -->
<div id="export-table-container"></div>

<script>
    (function() {
        // ----- Ø¹Ù†Ø§ØµØ± Ø§ØµÙ„ÛŒ -----
        const container = document.getElementById('productsContainer');
        const addBtn = document.getElementById('addProductBtn');
        const rateInput = document.getElementById('exchangeRate');
        const exportPng = document.getElementById('exportPngBtn');
        const exportPdf = document.getElementById('exportPdfBtn');
        const shareBtn = document.getElementById('shareBtn');

        // Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø¯ÛŒÙ (Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø¯ÛŒÙ)
        let productRows = [];  // Ø¢Ø±Ø§ÛŒÙ‡ Ø§ÛŒ Ø§Ø² Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§

        // Ù†Ø±Ø® Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        let currentRate = parseFloat(rateInput.value) || 2200;

        // ----- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¹Ø¯Ø¯Ù†ÙˆÛŒØ³ÛŒ -----
        function toFixedNumber(num, digits = 2) {
            if (isNaN(num) || num === null || num === '') return 0;
            return parseFloat(num).toFixed(digits);
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÛŒÚ© Ø±Ø¯ÛŒÙ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÛŒÙ†Ø¯Ú©Ø³
        function refreshRow(rowElement) {
            const index = rowElement.dataset.index;
            if (!index) return;

            // Ø¯Ø±ÛŒØ§ÙØª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
            const unitPerPack = parseFloat(rowElement.querySelector('.unit-per-pack')?.value) || 1;
            const packCount = parseFloat(rowElement.querySelector('.pack-count')?.value) || 0;
            const unitPurchase = parseFloat(rowElement.querySelector('.unit-purchase')?.value) || 0;
            const packPurchase = parseFloat(rowElement.querySelector('.pack-purchase')?.value) || 0;
            const unitSellT = parseFloat(rowElement.querySelector('.unit-sell-t')?.value) || 0;
            const unitSellAf = parseFloat(rowElement.querySelector('.unit-sell-af')?.value) || 0;

            // Ù‡Ù…Ø§Ù‡Ù†Ú¯â€ŒØ³Ø§Ø²ÛŒ Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ ØªÚ©ÛŒ Ùˆ Ø¨Ø³ØªÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ø¨Ø³ØªÙ‡
            let newUnitPurchase = unitPurchase;
            let newPackPurchase = packPurchase;
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù‚ÛŒÙ…Øª Ø¨Ø³ØªÙ‡ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ (Ø§Ø² Ø·Ø±ÛŒÙ‚ event listener Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            // Ø§ÛŒÙ†Ø¬Ø§ ÙÙ‚Ø· Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…. Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
            // (Ø¯Ø± event listener Ù‡Ø§ÛŒ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø± Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ pack sell Ùˆ unit sell Ø§Ø² Ø±ÙˆÛŒ ÛŒÚ©Ø¯ÛŒÚ¯Ø±
            // Ø§Ú¯Ø± unit sell Toman ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ unit sell Af Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø§Ù…Ø§ event listener Ø¬Ø¯Ø§ Ø¯Ø§Ø±ÛŒÙ…)
            // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ ØµØ±ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ read-only Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

            // Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ (ØªÙˆÙ…Ø§Ù†) = unitSellT * unitPerPack
            const packSellT = unitSellT * unitPerPack;
            // Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ (Ø§Ù) = unitSellAf * unitPerPack
            const packSellAf = unitSellAf * unitPerPack;

            // Ø³ÙˆØ¯Ù‡Ø§
            const profitUnitT = unitSellT - unitPurchase;
            const profitUnitAf = profitUnitT / currentRate;
            const profitPackT = packSellT - packPurchase;
            const profitPackAf = profitPackT / currentRate;

            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ read-only
            rowElement.querySelector('.pack-sell-t').textContent = toFixedNumber(packSellT);
            rowElement.querySelector('.pack-sell-af').textContent = toFixedNumber(packSellAf);
            rowElement.querySelector('.profit-unit-t').textContent = toFixedNumber(profitUnitT);
            rowElement.querySelector('.profit-unit-af').textContent = toFixedNumber(profitUnitAf);
            rowElement.querySelector('.profit-pack-t').textContent = toFixedNumber(profitPackT);
            rowElement.querySelector('.profit-pack-af').textContent = toFixedNumber(profitPackAf);

            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø¯ÛŒÙ (Ù†Ù…Ø§ÛŒØ´)
            const rowNumSpan = rowElement.querySelector('.row-num');
            if (rowNumSpan) {
                rowNumSpan.textContent = parseInt(index) + 1;
            }
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ù…Ù‡ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ (Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ø±Ø®)
        function refreshAllRows() {
            document.querySelectorAll('.product-card').forEach(card => refreshRow(card));
        }

        // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ Ù…Ø­ØµÙˆÙ„
        function createProductRow(index) {
            const template = `
                <div class="product-card" data-index="${index}">
                    <div class="row-header">
                        <div class="row-num">${index+1}</div>
                        <button class="delete-btn" onclick="this.closest('.product-card').remove(); refreshAllRowsAfterDelete()">âœ•</button>
                    </div>
                    <div class="product-fields">
                        <div class="full-row">
                            <label>ğŸ“¦ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</label>
                            <input type="text" class="product-name" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ù…Ù¾Ùˆ" value="Ú©Ø§Ù„Ø§ÛŒ ${index+1}">
                        </div>
                        <div>
                            <label>ğŸ”¢ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ø¨Ø³ØªÙ‡</label>
                            <input type="number" class="unit-per-pack" value="12" min="1" step="1">
                        </div>
                        <div>
                            <label>ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø³ØªÙ‡</label>
                            <input type="number" class="pack-count" value="1" min="0" step="1">
                        </div>
                        <div>
                            <label>ğŸ’µ Ù‚ÛŒÙ…Øª ØªÚ©ÛŒ Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                            <input type="number" class="unit-purchase" value="5000" step="100">
                        </div>
                        <div>
                            <label>ğŸ’µ Ù‚ÛŒÙ…Øª Ø¨Ø³ØªÙ‡ Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                            <input type="number" class="pack-purchase" value="60000" step="1000">
                        </div>
                        <div>
                            <label>ğŸ’° ÙØ±ÙˆØ´ ØªÚ©ÛŒ (ØªÙˆÙ…Ø§Ù†)</label>
                            <input type="number" class="unit-sell-t" value="8000" step="100">
                        </div>
                        <div>
                            <label>ğŸ’° ÙØ±ÙˆØ´ ØªÚ©ÛŒ (Ø§Ù)</label>
                            <input type="number" class="unit-sell-af" value="3.8" step="0.1">
                        </div>
                        <div>
                            <label>ğŸ·ï¸ ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ (ØªÙˆÙ…Ø§Ù†)</label>
                            <span class="readonly-field pack-sell-t">0</span>
                        </div>
                        <div>
                            <label>ğŸ·ï¸ ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ (Ø§Ù)</label>
                            <span class="readonly-field pack-sell-af">0</span>
                        </div>
                    </div>
                    <div class="profit-row">
                        <div class="profit-item">ğŸ“ˆ Ø³ÙˆØ¯ ØªÚ©ÛŒ (ØªÙˆÙ…Ø§Ù†): <span class="profit-unit-t">0</span></div>
                        <div class="profit-item">ğŸ“ˆ Ø³ÙˆØ¯ ØªÚ©ÛŒ (Ø§Ù): <span class="profit-unit-af">0</span></div>
                        <div class="profit-item">ğŸ“Š Ø³ÙˆØ¯ Ø¨Ø³ØªÙ‡ (ØªÙˆÙ…Ø§Ù†): <span class="profit-pack-t">0</span></div>
                        <div class="profit-item">ğŸ“Š Ø³ÙˆØ¯ Ø¨Ø³ØªÙ‡ (Ø§Ù): <span class="profit-pack-af">0</span></div>
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = template;
            const row = div.firstElementChild;

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listenerÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ
            const unitPerPackInput = row.querySelector('.unit-per-pack');
            const packCountInput = row.querySelector('.pack-count'); // ÙØ¹Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¬Ø² Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            const unitPurchaseInput = row.querySelector('.unit-purchase');
            const packPurchaseInput = row.querySelector('.pack-purchase');
            const unitSellTInput = row.querySelector('.unit-sell-t');
            const unitSellAfInput = row.querySelector('.unit-sell-af');

            // ÙˆÙ‚ØªÛŒ Ù‚ÛŒÙ…Øª ØªÚ©ÛŒ Ø®Ø±ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ â†’ Ù‚ÛŒÙ…Øª Ø¨Ø³ØªÙ‡ Ø®Ø±ÛŒØ¯ = ØªÚ©ÛŒ * ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ø¨Ø³ØªÙ‡
            unitPurchaseInput.addEventListener('input', function() {
                const perPack = parseFloat(unitPerPackInput.value) || 1;
                const unitVal = parseFloat(this.value) || 0;
                packPurchaseInput.value = (unitVal * perPack).toFixed(0);
                refreshRow(row);
            });

            // ÙˆÙ‚ØªÛŒ Ù‚ÛŒÙ…Øª Ø¨Ø³ØªÙ‡ Ø®Ø±ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ â†’ Ù‚ÛŒÙ…Øª ØªÚ©ÛŒ Ø®Ø±ÛŒØ¯ = Ø¨Ø³ØªÙ‡ / ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ø¨Ø³ØªÙ‡
            packPurchaseInput.addEventListener('input', function() {
                const perPack = parseFloat(unitPerPackInput.value) || 1;
                const packVal = parseFloat(this.value) || 0;
                unitPurchaseInput.value = (packVal / perPack).toFixed(0);
                refreshRow(row);
            });

            // ÙˆÙ‚ØªÛŒ ÙØ±ÙˆØ´ ØªÚ©ÛŒ ØªÙˆÙ…Ø§Ù† ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ â†’ ÙØ±ÙˆØ´ ØªÚ©ÛŒ Ø§Ù = ØªÙˆÙ…Ø§Ù† / Ù†Ø±Ø® ØŒ Ùˆ ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ Ø¢Ù¾Ø¯ÛŒØª
            unitSellTInput.addEventListener('input', function() {
                const tVal = parseFloat(this.value) || 0;
                unitSellAfInput.value = (tVal / currentRate).toFixed(2);
                refreshRow(row);
            });

            // ÙˆÙ‚ØªÛŒ ÙØ±ÙˆØ´ ØªÚ©ÛŒ Ø§Ù ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ â†’ ÙØ±ÙˆØ´ ØªÚ©ÛŒ ØªÙˆÙ…Ø§Ù† = Ø§Ù * Ù†Ø±Ø®
            unitSellAfInput.addEventListener('input', function() {
                const afVal = parseFloat(this.value) || 0;
                unitSellTInput.value = (afVal * currentRate).toFixed(0);
                refreshRow(row);
            });

            // ÙˆÙ‚ØªÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ø¨Ø³ØªÙ‡ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ â†’ Ø¨Ø§ÛŒØ¯ Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ Ø¨Ø³ØªÙ‡ Ùˆ ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ Ø¢Ù¾Ø¯ÛŒØª Ø´ÙˆÙ†Ø¯
            unitPerPackInput.addEventListener('input', function() {
                // Ù‡Ù…Ø§Ù‡Ù†Ú¯â€ŒØ³Ø§Ø²ÛŒ Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ Ø¨Ø³ØªÙ‡ Ø§Ø² Ø±ÙˆÛŒ ØªÚ©ÛŒ
                const perPack = parseFloat(this.value) || 1;
                const unitPur = parseFloat(unitPurchaseInput.value) || 0;
                packPurchaseInput.value = (unitPur * perPack).toFixed(0);
                // Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ ØªØºÛŒÛŒØ± ÙØ±ÙˆØ´ ØªÚ©ÛŒ Ù†ÛŒØ³ØªØŒ ÙˆÙ„ÛŒ ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ Ø¯Ø± refresh Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                refreshRow(row);
            });

            // Ù†Ø±Ø® Ø¨Ù‡â€ŒØ±ÙˆØ²: Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±Ø¯ÛŒÙ ÛŒÚ© listener Ø±ÙˆÛŒ Ù†Ø±Ø® Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø§Ø² refreshAllRows Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

            // ÛŒÙ‡ Ú©Ù… bootstrap: ÛŒÚ©Ø¨Ø§Ø± refresh Ú©Ù†
            refreshRow(row);
            return row;
        }

        // Ø¨Ø¹Ø¯ Ø§Ø² Ø­Ø°Ù Ø±Ø¯ÛŒÙ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù…Ø±ØªØ¨ Ú©Ù†
        window.refreshAllRowsAfterDelete = function() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach((card, idx) => {
                card.dataset.index = idx;
                const numSpan = card.querySelector('.row-num');
                if (numSpan) numSpan.textContent = idx + 1;
                refreshRow(card);
            });
        };

        // Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯
        addBtn.addEventListener('click', function() {
            const newIndex = document.querySelectorAll('.product-card').length;
            const newRow = createProductRow(newIndex);
            container.appendChild(newRow);
            refreshAllRowsAfterDelete(); // Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§
        });

        // ØªØºÛŒÛŒØ± Ù†Ø±Ø® Ø§Ø±Ø²
        rateInput.addEventListener('input', function() {
            currentRate = parseFloat(this.value) || 2200;
            // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ AF Ø¯Ø± ØªÙ…Ø§Ù… Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§
            document.querySelectorAll('.product-card').forEach(card => {
                const unitSellAf = card.querySelector('.unit-sell-af');
                const unitSellT = card.querySelector('.unit-sell-t');
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ø§Ù Ø§Ø² Ø±ÙˆÛŒ ØªÙˆÙ…Ø§Ù† (Ø¨Ø±Ø§ÛŒä¿æŒä¸€è‡´)
                if (unitSellT && unitSellAf) {
                    const tVal = parseFloat(unitSellT.value) || 0;
                    unitSellAf.value = (tVal / currentRate).toFixed(2);
                }
                refreshRow(card);
            });
        });

        // Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        (function init() {
            container.innerHTML = '';
            const firstRow = createProductRow(0);
            container.appendChild(firstRow);
        })();

        // --- ØªÙˆØ§Ø¨Ø¹ Ø®Ø±ÙˆØ¬ÛŒ PNG Ùˆ PDF Ùˆ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ ---
        function buildExportTableHTML() {
            const invoiceNo = document.getElementById('invoiceNo').value;
            const purchaseDate = document.getElementById('purchaseDate').value;
            const saleDate = document.getElementById('saleDate').value;
            const seller = document.getElementById('seller').value;
            const buyer = document.getElementById('buyer').value;
            const rate = currentRate;

            let rowsHTML = '';
            const cards = document.querySelectorAll('.product-card');
            cards.forEach((card, idx) => {
                const name = card.querySelector('.product-name')?.value || '---';
                const unitPerPack = card.querySelector('.unit-per-pack')?.value || 1;
                const packCount = card.querySelector('.pack-count')?.value || 0;
                const unitPur = card.querySelector('.unit-purchase')?.value || 0;
                const packPur = card.querySelector('.pack-purchase')?.value || 0;
                const unitSellT = card.querySelector('.unit-sell-t')?.value || 0;
                const unitSellAf = card.querySelector('.unit-sell-af')?.value || 0;
                const packSellT = card.querySelector('.pack-sell-t')?.textContent || '0';
                const packSellAf = card.querySelector('.pack-sell-af')?.textContent || '0';
                const profitUnitT = card.querySelector('.profit-unit-t')?.textContent || '0';
                const profitUnitAf = card.querySelector('.profit-unit-af')?.textContent || '0';
                const profitPackT = card.querySelector('.profit-pack-t')?.textContent || '0';
                const profitPackAf = card.querySelector('.profit-pack-af')?.textContent || '0';

                rowsHTML += `<tr>
                    <td>${idx+1}</td>
                    <td>${name}</td>
                    <td>${unitPerPack}</td>
                    <td>${packCount}</td>
                    <td>${unitPur}</td>
                    <td>${packPur}</td>
                    <td>${unitSellT}</td>
                    <td>${unitSellAf}</td>
                    <td>${packSellT}</td>
                    <td>${packSellAf}</td>
                    <td>${profitUnitT}</td>
                    <td>${profitUnitAf}</td>
                    <td>${profitPackT}</td>
                    <td>${profitPackAf}</td>
                </tr>`;
            });

            return `
                <h3 style="text-align:center; margin-bottom:10px;">ÙØ§Ú©ØªÙˆØ± Ø®Ø±ÛŒØ¯ Ø¹Ù…Ø¯Ù‡</h3>
                <p><strong>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</strong> ${invoiceNo} | <strong>ØªØ§Ø±ÛŒØ® Ø®Ø±ÛŒØ¯:</strong> ${purchaseDate} | <strong>ØªØ§Ø±ÛŒØ® ÙØ±ÙˆØ´:</strong> ${saleDate || '---'}</p>
                <p><strong>ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</strong> ${seller} | <strong>Ø®Ø±ÛŒØ¯Ø§Ø±:</strong> ${buyer} | <strong>Ù†Ø±Ø® AF Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†:</strong> ${rate}</p>
                <table class="export-table" dir="rtl">
                    <thead>
                        <tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th><th>ØªØ¹Ø¯Ø§Ø¯/Ø¨Ø³ØªÙ‡</th><th>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø³ØªÙ‡</th><th>Ø®Ø±ÛŒØ¯ ØªÚ©ÛŒ (Øª)</th><th>Ø®Ø±ÛŒØ¯ Ø¨Ø³ØªÙ‡ (Øª)</th><th>ÙØ±ÙˆØ´ ØªÚ©ÛŒ (Øª)</th><th>ÙØ±ÙˆØ´ ØªÚ©ÛŒ (Ø§Ù)</th><th>ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ (Øª)</th><th>ÙØ±ÙˆØ´ Ø¨Ø³ØªÙ‡ (Ø§Ù)</th><th>Ø³ÙˆØ¯ ØªÚ©ÛŒ (Øª)</th><th>Ø³ÙˆØ¯ ØªÚ©ÛŒ (Ø§Ù)</th><th>Ø³ÙˆØ¯ Ø¨Ø³ØªÙ‡ (Øª)</th><th>Ø³ÙˆØ¯ Ø¨Ø³ØªÙ‡ (Ø§Ù)</th></tr>
                    </thead>
                    <tbody>
                        ${rowsHTML}
                    </tbody>
                </table>
                <p style="margin-top:10px; font-style:italic;">ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´: ${new Date().toLocaleDateString('fa-IR')}</p>
            `;
        }

        async function captureExportDiv() {
            const exportDiv = document.getElementById('export-table-container');
            exportDiv.innerHTML = buildExportTableHTML();
            exportDiv.style.background = 'white';
            exportDiv.style.padding = '20px';
            exportDiv.style.width = '800px';
            // Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† canvas
            return await html2canvas(exportDiv, { scale: 2, backgroundColor: '#ffffff' });
        }

        exportPng.addEventListener('click', async function() {
            try {
                const canvas = await captureExportDiv();
                const link = document.createElement('a');
                link.download = 'faktor.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª PNG');
            }
        });

        exportPdf.addEventListener('click', async function() {
            try {
                const canvas = await captureExportDiv();
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width * 0.5, canvas.height * 0.5] // ØªÙ‚Ø±ÛŒØ¨ÛŒ
                });
                pdf.addImage(imgData, 'PNG', 10, 10, canvas.width * 0.45, canvas.height * 0.45);
                pdf.save('faktor.pdf');
            } catch (e) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª PDF');
            }
        });

        shareBtn.addEventListener('click', async function() {
            try {
                const canvas = await captureExportDiv();
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                if (navigator.share) {
                    navigator.share({
                        title: 'ÙØ§Ú©ØªÙˆØ± Ø®Ø±ÛŒØ¯',
                        text: 'ÙØ§Ú©ØªÙˆØ± Ø¹Ù…Ø¯Ù‡ ÙØ±ÙˆØ´ÛŒ',
                        files: [new File([blob], 'faktor.png', { type: 'image/png' })]
                    }).catch(() => alert('Ø§Ø´ØªØ±Ø§Ú© Ù„ØºÙˆ Ø´Ø¯ ÛŒØ§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'));
                } else {
                    alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø§Ø´ØªØ±Ø§Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. ÙØ§ÛŒÙ„ PNG Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'faktor.png';
                    link.click();
                }
            } catch (e) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ');
            }
        });

        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø±ÙˆØ² Ø¨ÙˆØ¯Ù† Ù‡Ù…Ù‡ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± Ù†Ø±Ø® Ø§ÙˆÙ„ÛŒÙ‡
        setTimeout(() => refreshAllRows(), 100);
    })();
</script>
</body>
</html>
